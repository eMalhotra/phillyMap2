<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZIP Count Map</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }

    #maps-wrapper {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 80px;
    }

    .map-container {
      width: 45vw;
      height: 75vh;
      background-color: #ffffff;
      position: relative;
    }

    /* Top control buttons */
    #controls {
      position: fixed;
      top: 20px;
      left: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 20;
    }

    #controls button {
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
    }

    /* Year buttons inside map */
    .year-buttons {
      position: absolute;
      bottom: 10px;
      left: 10px;
      display: flex;
      gap: 5px;
    }

    .year-buttons button {
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    /* Tooltip */
    .tooltip {
      position: absolute;
      pointer-events: none;
      background: rgba(255,255,255,0.9);
      border: 1px solid #999;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
      z-index: 100;
    }
  </style>
</head>
<body>

<!-- Top control buttons -->
<div id="controls">
  <button id="btnCount">Count Fill</button>
  <button id="btnPercent">Percentage Fill</button>
  <button id="btnTogglePoints">Toggle Polling Places</button>
  <button id="btnDistricts">Toggle District Map</button>
  <button id="btnWards">Toggle Ward Map</button>
</div>

<!-- Maps side by side -->
<div id="maps-wrapper">
  <div id="map-container1" class="map-container">
    <div class="tooltip" id="tooltip1"></div>
    <div class="year-buttons"></div>
  </div>
  <div id="map-container2" class="map-container">
    <div class="tooltip" id="tooltip2"></div>
    <div class="year-buttons"></div>
  </div>
</div>

<script>
const csvFiles = {
  "2022": "users2022.csv",
  "2023": "users2023.csv",
  "2024": "users2024.csv",
  "2025": "users2025.csv"
};

let countMode = false;
let percentMode = false;
let pollingPlacesVisible = false;
let districtsVisible = false;
let wardsVisible = false;

function createMap(containerId, tooltipId) {
  let currentCSV = "userPopData.csv";
  const tooltip = d3.select("#" + tooltipId);

  const container = document.getElementById(containerId);
  const svgWidth = container.clientWidth;
  const svgHeight = container.clientHeight;

  // Create SVG once
  const svg = d3.select("#" + containerId).append("svg")
    .attr("width", svgWidth)
    .attr("height", svgHeight);

  let zipPaths, polling, districtsLayer, overlay2Layer;
  let countColor, percentColor, countExtent, pctExtent;
  let projection, path;

  // -------------------- Load CSV and update ZIP fills --------------------
  function loadCSV(csvFile) {
    d3.csv(csvFile).then(csvData => {
      const zipCountMap = {};
      const zipPercentMap = {};
      csvData.forEach(d => {
        const zip = d.ZIP?.trim();
        zipCountMap[zip] = +d.userCount || null;
        zipPercentMap[zip] = +d.userPercentage || null;
      });

      countExtent = d3.extent(csvData, d => +d.userCount);
      pctExtent = d3.extent(csvData, d => +d.userPercentage);
      countColor = d3.scaleSequential()
  .domain([countExtent[0], countExtent[1]])
  .interpolator(d3.interpolateBlues);

percentColor = d3.scaleLinear()
  .domain([pctExtent[0], pctExtent[1]*0.5, pctExtent[1]])  // mid-point
  .range(["#ffffff", "#ff6666", "#cc0000"]);  // light pink → bright red → dark red


      d3.json("zipMapPhilly.geojson").then(mapData => {
        mapData.features.forEach(f => {
          const zip = f.properties.CODE?.trim();
          f.properties.count = zipCountMap[zip] ?? null;
          f.properties.percent = zipPercentMap[zip] ?? null;
        });

        projection = d3.geoMercator().fitSize([svgWidth, svgHeight], mapData);
        path = d3.geoPath().projection(projection);

        // If paths already exist, just update data
        if (zipPaths) {
          zipPaths.data(mapData.features)
            .attr("d", path)
            .each(function(d) { this.__data__ = d; }); // update data reference
        } else {
          // First time: create ZIP paths
          zipPaths = svg.selectAll("path.zip")
            .data(mapData.features)
            .enter().append("path")
            .attr("class", "zip")
            .attr("d", path)
            .attr("fill", "white")
            .attr("stroke", "lightgray")
            .attr("stroke-width", 1)
            .on("mousemove", (event,d) => {
              tooltip
                .style("display","block")
                .style("left",(event.offsetX+15)+"px")
                .style("top",(event.offsetY+15)+"px")
                .html(`
                  <strong>ZIP:</strong> ${d.properties.CODE}<br>
                  <strong>Count:</strong> ${d.properties.count ?? "No data"}<br>
                  <strong>Percent:</strong> ${d.properties.percent ?? "No data"}
                `);
            })
            .on("mouseleave", () => tooltip.style("display","none"));
        }

        // Update fills for current mode
        updateDisplay();
      });
    });
  }

  // -------------------- Year buttons --------------------
  const yearDiv = document.querySelector(`#${containerId} .year-buttons`);
  Object.keys(csvFiles).forEach(year => {
    const btn = document.createElement("button");
    btn.innerText = year;

    btn.onclick = () => {
      // Reset all buttons to default
      yearDiv.querySelectorAll("button").forEach(b => {
        b.style.backgroundColor = "";
        b.style.color = "";
        b.style.fontWeight = "normal";
      });

      // Highlight selected button
      btn.style.backgroundColor = "#03387f";
      btn.style.color = "white";
      btn.style.fontWeight = "bold";

      currentCSV = csvFiles[year];
      loadCSV(currentCSV);
    };

    yearDiv.appendChild(btn);
  });

 // -------------------- Polling places --------------------
if (!polling) {
  d3.json("polling_places.geojson").then(pointData => {
    polling = svg.selectAll(".polling-place")
      .data(pointData.features)
      .enter().append("circle")
      .attr("class", "polling-place")
      .attr("cx", d => projection(d.geometry.coordinates)[0])
      .attr("cy", d => projection(d.geometry.coordinates)[1])
      .attr("r", 2)
      .attr("fill", "blue")
      .attr("opacity", 0.9)
      .style("display", pollingPlacesVisible ? "block" : "none");
  });
}


  // -------------------- District overlay --------------------
  d3.json("Council_Districts_2024.geojson").then(districtData => {
    districtsLayer = svg.append("g")
      .attr("class","district-overlay")
      .selectAll("path")
      .data(districtData.features)
      .enter().append("path")
      .attr("d", path)
      .attr("fill","none")
      .attr("stroke","black")
      .attr("stroke-width",2)
      .style("display","none");
  });

  // -------------------- Ward overlay --------------------
  d3.json("wardMap.geojson").then(wardData => {
    overlay2Layer = svg.append("g")
      .attr("class","overlay2")
      .selectAll("path")
      .data(wardData.features)
      .enter().append("path")
      .attr("d", path)
      .attr("fill","gray")
      .attr("fill-opacity",0.5)
      .attr("stroke","black")
      .attr("stroke-width",1.5)
      .style("display","none");
  });

  // -------------------- Update display --------------------
  function updateDisplay() {
    if(zipPaths) {
      if(countMode) {
        zipPaths.attr("fill", d => d.properties.count != null ? countColor(d.properties.count) : "#ddd")
          .attr("stroke","black");
      } else if(percentMode) {
        zipPaths.attr("fill", d => d.properties.percent != null ? percentColor(d.properties.percent) : "#ddd")
          .attr("stroke","black");
      } else {
        zipPaths.attr("fill","white").attr("stroke","lightgray");
      }
    }

    if(polling) polling.style("display", pollingPlacesVisible ? "block" : "none");
    if(districtsLayer) districtsLayer.style("display", districtsVisible ? "block" : "none");
    if(overlay2Layer) overlay2Layer.style("display", wardsVisible ? "block" : "none");
  }

  // Initial CSV load
  loadCSV(currentCSV);

  return { updateDisplay };
}

// Create two maps
const map1 = createMap("map-container1", "tooltip1");
const map2 = createMap("map-container2", "tooltip2");

// ----------------- GLOBAL CONTROL BUTTONS -----------------
document.getElementById("btnCount").onclick = () => {
  countMode = !countMode;
  percentMode = false;
  map1.updateDisplay();
  map2.updateDisplay();
};
document.getElementById("btnPercent").onclick = () => {
  percentMode = !percentMode;
  countMode = false;
  map1.updateDisplay();
  map2.updateDisplay();
};
document.getElementById("btnTogglePoints").onclick = () => {
  pollingPlacesVisible = !pollingPlacesVisible;
  map1.updateDisplay();
  map2.updateDisplay();
};
document.getElementById("btnDistricts").onclick = () => {
  districtsVisible = !districtsVisible;
  map1.updateDisplay();
  map2.updateDisplay();
};
document.getElementById("btnWards").onclick = () => {
  wardsVisible = !wardsVisible;
  map1.updateDisplay();
  map2.updateDisplay();
};
</script>

</body>
</html>
